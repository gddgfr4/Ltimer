<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>多機能トレーニングタイマー Pro — Mobile</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --approaching-warn-color:#facc15; /* yellow-400 */
      --approaching-imminent-color:#fb923c; /* orange-400 */
      --exceeded-color:#f87171; /* red-400 */
      --work-color:#4ade80; /* green-400 */
      --rest-color:#60a5fa; /* blue-400 */
      /* 動的フォント/サイズ（JSで行数に応じて上書き） */
      --font-main:32px;  /* Total */
      --font-live:28px;  /* Lap live */
      --font-small:16px; /* small text */
      --btn-h:56px;      /* 各カードのボタン高さ */
      --master-h:64px;   /* 下マスターの高さ */
      --master-btn-py:12px; /* 下マスターのボタン上下padding */
      --master-btn-fs:16px;  /* 下マスターのボタン文字 */
    }

    html,body{height:100dvh;margin:0;padding:0;overflow:hidden;background:#e5e7eb;touch-action:manipulation;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif}
    .timer-font{font-variant-numeric:tabular-nums}

    /* 画面: 選択/各モード */
    .screen{position:relative; height:100%; width:100%;}
    .hidden{display:none}

    /* 戻るボタン */
    .back-btn{position:fixed; left:env(safe-area-inset-left,8px); top:calc(env(safe-area-inset-top,8px) + 8px); z-index:60;}
    .back-btn button{width:44px;height:44px;border-radius:9999px}

    /* === Split Mode === */
    .split-wrap{display:flex;flex-direction:column;height:100%;}
    .split-grid{display:grid;flex:1 1 auto;padding:6px;gap:6px;overflow:hidden;}
    .split-card{background:#F9FAFB;border-radius:12px;padding:8px;display:grid;grid-template-columns:1fr 1fr;grid-template-rows:auto auto auto 1fr auto;gap:6px;height:100%;}

    .split-card-header{grid-column:1/-1;display:grid;grid-template-columns:1fr minmax(86px,42%);gap:6px;align-items:center}
    .split-name-input{min-width:0;text-align:left}
    .target-lap-input{min-width:0;text-align:center;padding:4px 6px}

    .split-main-time{grid-column:1/-1;font-size:var(--font-main);font-weight:800}
    .split-lap-live{grid-column:1/-1;font-size:var(--font-live);font-weight:800;border-radius:8px;padding:4px 6px}
    .split-lap-live.good{color:#065f46;background:#d1fae5}
    .split-lap-live.warn{color:#7c2d12;background:#ffedd5}
    .split-lap-live.bad{ color:#991b1b;background:#fee2e2}

    .split-lap-history{grid-column:1/-1;overflow-y:auto;min-height:1.6em;background:rgba(229,231,235,.8);border-radius:8px;padding:4px 6px;line-height:1.2;font-size:clamp(11px,2.8vw,13px)}
    .split-lap-history .hist-line{margin-bottom:2px}
    .split-lap-history .hist-n{margin-right:4px;font-weight:700}
    .split-lap-history .hist-cum{margin-left:4px;color:#6b7280}

    .split-actions{grid-column:1/-1;display:grid;grid-template-columns:1fr 1fr;gap:6px}
    .split-actions button{height:var(--btn-h)}

    .split-master{height:var(--master-h);background:#1f2937;color:white;display:flex;gap:8px;align-items:center;justify-content:space-around;padding:8px}
    .split-master .btn{padding-top:var(--master-btn-py);padding-bottom:var(--master-btn-py);font-size:var(--master-btn-fs)}

    /* === Pacemaker === */
    .pm-grid{display:grid;grid-auto-rows:minmax(180px,1fr);gap:6px;height:100%;padding:6px;overflow:hidden}
    .pm-lane{display:grid;grid-template-columns:2fr 3fr;grid-template-rows:1fr 1fr 1fr;background:#fff;border-radius:12px;padding:8px}
    .pm-lane-main{grid-row:1/-1;display:flex;flex-direction:column;align-items:center;justify-content:center;border-right:1px solid #e5e7eb}
    .pm-lane-history{font-size:12px;display:flex;flex-wrap:wrap;align-content:flex-start;gap:4px}
    .pm-lane-rest{background:var(--rest-color)!important;color:#fff}

    /* === Custom Timer === */
    .custom-runner{transition:background-color .3s}
    .work-bg{background:var(--work-color)}
    .rest-bg{background:var(--rest-color);color:#fff}

    /* Summary modal */
    .summary-modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;justify-content:center;align-items:center;z-index:70;padding:16px}
    .summary-content{background:#fff;border-radius:12px;padding:16px;width:100%;max-width:600px;max-height:90vh;overflow:auto}

    @media (max-width:430px){
      .split-card{gap:4px;padding:6px}
      .split-card-header{grid-template-columns:1fr minmax(80px,48%)}
    }
  </style>
</head>
<body>
  <!-- モード選択画面 -->
  <section id="screen-chooser" class="screen flex flex-col items-center justify-center gap-5 p-6">
    <h1 class="text-2xl font-bold mb-2">モードを選択</h1>
    <div class="grid grid-cols-1 gap-3 w-full max-w-sm">
      <button id="choose-split" class="py-4 text-xl font-bold text-white bg-indigo-600 rounded-xl shadow">スプリット</button>
      <button id="choose-pm" class="py-4 text-xl font-bold text-white bg-green-600 rounded-xl shadow">ペースメーカー</button>
      <button id="choose-custom" class="py-4 text-xl font-bold text-white bg-gray-800 rounded-xl shadow">タイマー</button>
    </div>
  </section>

  <!-- 戻るボタン（モード時のみ表示） -->
  <div id="back" class="back-btn hidden">
    <button class="bg-white shadow text-xl" aria-label="戻る">←</button>
  </div>

  <!-- Split -->
  <section id="screen-split" class="screen hidden">
    <div class="split-wrap">
      <div id="split-grid" class="split-grid"></div>
      <div id="split-master" class="split-master">
        <button data-action="add" class="w-12 h-12 rounded-full bg-blue-500 text-white text-2xl">+</button>
        <button data-action="remove" class="w-12 h-12 rounded-full bg-gray-500 text-white text-2xl">−</button>
        <button data-action="start-all" class="btn px-4 bg-green-500 rounded font-bold">START ALL</button>
        <button data-action="stop-all"  class="btn px-4 bg-red-500 rounded font-bold">STOP ALL</button>
        <button data-action="reset-all" class="btn px-4 bg-orange-500 rounded font-bold">RESET ALL</button>
      </div>
    </div>
  </section>

  <!-- Pacemaker -->
  <section id="screen-pm" class="screen hidden">
    <div id="pm-settings" class="p-4 space-y-3">
      <h2 class="text-xl font-bold text-center">ペースメーカー設定</h2>
      <div class="grid grid-cols-2 gap-3">
        <input id="pm-distance" type="number" placeholder="距離(m)" class="p-2 border rounded-md text-lg col-span-2">
        <input id="pm-reps" type="number" placeholder="本数" class="p-2 border rounded-md text-lg">
        <div>
          <button id="pm-lane-minus" class="px-3 py-2 border rounded-l-md">-</button>
          <span id="pm-lane-count" class="px-4 py-2 border-t border-b">1レーン</span>
          <button id="pm-lane-plus" class="px-3 py-2 border rounded-r-md">+</button>
        </div>
        <div class="col-span-2 flex items-center gap-2">
          <input id="pm-rest-dist" type="number" placeholder="レスト距離(m)" class="p-2 border rounded-md text-lg w-full">
          <input type="checkbox" id="pm-return-to-start" class="h-5 w-5 ml-2"><label for="pm-return-to-start">開始点へ</label>
        </div>
      </div>
      <div id="pm-lane-targets" class="space-y-2"></div>
      <button id="pm-start-btn" class="w-full mt-1 py-3 text-2xl font-bold text-white bg-green-500 rounded-lg shadow-lg">練習開始</button>
    </div>
    <div id="pm-runner" class="hidden h-full">
      <div id="pm-grid" class="pm-grid"></div>
    </div>
  </section>

  <!-- Custom Timer -->
  <section id="screen-custom" class="screen hidden">
    <div id="custom-settings" class="p-4">
      <h2 class="text-xl font-bold text-center mb-4">タイマー設定</h2>
      <div id="custom-steps-container" class="space-y-2"></div>
      <button id="custom-add-step-btn" class="w-full mt-4 py-2 text-lg text-indigo-600 border-2 border-indigo-600 rounded-lg">ステップを追加</button>
      <div class="mt-4">
        <label for="custom-reps" class="font-bold">セット数:</label>
        <input id="custom-reps" type="number" value="1" class="w-full p-2 border rounded-md text-lg mt-1">
      </div>
      <button id="custom-start-btn" class="w-full mt-4 py-3 text-2xl font-bold text-white bg-green-500 rounded-lg shadow-lg">START</button>
    </div>
    <div id="custom-runner" class="hidden h-full flex flex-col justify-between items-center text-center p-4 custom-runner">
      <div>
        <div id="custom-runner-set-info" class="text-3xl font-bold">SET 1 / 1</div>
        <div id="custom-runner-step-info" class="text-2xl">WORK 1 / 2</div>
      </div>
      <div id="custom-runner-time" class="text-9xl font-extrabold timer-font">00:30</div>
      <div class="w-full"><button id="custom-reset-btn" class="w-full py-4 text-2xl font-bold text-gray-700 bg-gray-200 rounded-lg">RESET</button></div>
    </div>
  </section>

  <!-- Summary Modal -->
  <div id="summary" class="summary-modal hidden">
    <div class="summary-content">
      <h2 id="summary-title" class="text-2xl font-bold text-center">練習結果</h2>
      <div id="summary-table"></div>
      <div class="flex gap-4 mt-6">
        <button id="summary-csv" class="w-full py-3 text-lg font-bold text-white bg-green-600 rounded-lg">CSVダウンロード</button>
        <button id="summary-close" class="w-full py-3 text-lg font-bold text-gray-700 bg-gray-200 rounded-lg">閉じる</button>
      </div>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    /* ====== Screen Navigation ====== */
    const screens = {
      chooser: document.getElementById('screen-chooser'),
      split:   document.getElementById('screen-split'),
      pm:      document.getElementById('screen-pm'),
      custom:  document.getElementById('screen-custom'),
    };
    const backWrap = document.getElementById('back');
    let current = 'chooser';

    function show(screen){
      Object.values(screens).forEach(el=>el.classList.add('hidden'));
      screens[screen].classList.remove('hidden');
      current = screen;
      backWrap.classList.toggle('hidden', screen==='chooser');
      if(screen==='split') recalibrateSplitLayout();
    }

    document.getElementById('choose-split').onclick = ()=>{ initSplit(); show('split'); };
    document.getElementById('choose-pm').onclick    = ()=>{ initPM(); show('pm'); };
    document.getElementById('choose-custom').onclick= ()=>{ initCustom(); show('custom'); };
    backWrap.querySelector('button').onclick = ()=>{ show('chooser'); };

    /* ====== Audio ====== */
    let audioCtx; function initAudio(){ if(!audioCtx){ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); } }
    document.body.addEventListener('click', initAudio, {once:true});
    function beep(f,ms){ if(!audioCtx) return; const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.type='sine'; o.frequency.value=f; g.gain.value=0.1; o.start(); o.stop(audioCtx.currentTime+ms/1000); }

    /* ====== Utils ====== */
    const fmt=(ms,h=true)=>{ if(isNaN(ms)||ms<0) ms=0; const d=new Date(ms); const m=String(d.getUTCMinutes()); const s=String(d.getUTCSeconds()).padStart(2,'0'); if(!h) return `${m}:${s}`; const hnd=String(Math.floor(d.getUTCMilliseconds()/10)).padStart(2,'0'); return `${m}:${s}.${hnd}`; };

    /* ====== Split Mode ====== */
    let watches=[]; let rafId;
    const splitGrid = document.getElementById('split-grid');
    const splitMaster = document.getElementById('split-master');

    function initSplit(){
      watches=[{id:0,name:'時計 1',running:false,start:0,elapsed:0,lastLap:0,laps:[],target:0,freezeUntil:0,frozenLap:0,pendingLast:null}];
      renderSplit();
    }

    // 列/行・行高・フォントサイズを再計算
    function recalibrateSplitLayout(){
      const count=watches.length;
      const cols=(count>=2)?2:1; // 2台以上は2列
      splitGrid.style.gridTemplateColumns = cols===2 ? '1fr 1fr' : '1fr';

      const rows=Math.ceil(count/cols);
      const st=getComputedStyle(splitGrid);
      const padV=parseFloat(st.paddingTop)+parseFloat(st.paddingBottom);
      const gap=parseFloat(st.gap)||6;
      const avail = screens.split.clientHeight - splitMaster.offsetHeight - padV;
      const rowH = Math.max(150, Math.floor((avail - (rows-1)*gap)/rows));
      splitGrid.style.gridAutoRows = rowH+'px';

      // 行数に応じてフォント・ボタン・マスターを可変化
      let main=32, live=28, small=16;
      let btnH=56, masterH=64, masterBtnPy=12, masterBtnFs=16;
      if(rows>=3){ // 5個(=2列3行)など
        main=24; live=20; small=14;
        btnH=44; masterH=52; masterBtnPy=6; masterBtnFs=14;
      }else if(rows===2){
        main=30; live=26; small=15;
        btnH=52; masterH=60; masterBtnPy=10; masterBtnFs=15;
      }
      const root=document.documentElement;
      root.style.setProperty('--font-main',  main+'px');
      root.style.setProperty('--font-live',  live+'px');
      root.style.setProperty('--font-small', small+'px');
      root.style.setProperty('--btn-h', btnH+'px');
      root.style.setProperty('--master-h', masterH+'px');
      root.style.setProperty('--master-btn-py', masterBtnPy+'px');
      root.style.setProperty('--master-btn-fs', masterBtnFs+'px');
    }
    window.addEventListener('resize', ()=>{ if(current==='split') recalibrateSplitLayout(); });

    function renderSplit(){
      splitGrid.innerHTML = watches.map(sw=>{
        let cum=0; const hist = sw.laps.map((lap,i)=>{cum+=lap; return {n:i+1,lap,cum};}).slice().reverse()
          .map(h=>`<div class="hist-line"><span class="hist-n">${h.n}</span><span class="hist-lap">${fmt(h.lap)}</span><span class="hist-cum">(${fmt(h.cum)})</span></div>`).join('') || '<p class="text-xs text-center text-gray-400">ラップ履歴</p>';
        return `<div class="split-card" id="w-${sw.id}">
          <div class="split-card-header">
            <input type="text" value="${sw.name}" data-id="${sw.id}" class="split-name-input p-1 bg-gray-100 rounded font-bold">
            <input type="number" data-id="${sw.id}" placeholder="目標(sec)" value="${sw.target>0?sw.target:''}" class="target-lap-input border-2 rounded">
          </div>
          <div class="split-main-time timer-font text-gray-900">${fmt(sw.elapsed)}</div>
          <div class="split-lap-live timer-font" id="live-${sw.id}">${fmt(sw.elapsed - sw.lastLap)}</div>
          <div class="split-lap-history">${hist}</div>
          <div class="split-actions">
            <button data-id="${sw.id}" data-action="start" class="text-white font-bold rounded ${sw.running?'bg-red-500':'bg-green-500'}">${sw.running?'STOP':'START'}</button>
            <button data-id="${sw.id}" data-action="lap" class="text-white font-bold rounded bg-gray-700">LAP (${sw.laps.length+1})</button>
          </div>
        </div>`; }).join('');
      recalibrateSplitLayout();
      wireSplit();
    }

    function wireSplit(){
      // 入力
      splitGrid.querySelectorAll('.target-lap-input,.split-name-input').forEach(el=>{
        el.oninput=(e)=>{
          const id=+e.target.dataset.id; const sw=watches.find(w=>w.id===id); if(!sw) return;
          if(e.target.classList.contains('target-lap-input')) sw.target=parseFloat(e.target.value)||0; else sw.name=e.target.value;
        }
      });
      // ボタン
      splitGrid.querySelectorAll('button').forEach(btn=>{
        btn.onclick=(e)=>{
          const id=+e.currentTarget.dataset.id; const action=e.currentTarget.dataset.action; const sw=watches.find(w=>w.id===id); if(!sw) return;
          if(action==='start'){ sw.running=!sw.running; if(sw.running) sw.start=Date.now()-sw.elapsed; renderSplit(); }
          if(action==='lap' && sw.running){ const now=Date.now(); const lap=sw.elapsed - sw.lastLap; sw.laps.push(lap); sw.frozenLap=lap; sw.freezeUntil=now+3000; sw.pendingLast=sw.elapsed; renderSplit(); }
        }
      });
      // マスター
      splitMaster.querySelectorAll('button').forEach(b=>{
        b.onclick=(e)=>{
          const a=e.currentTarget.dataset.action; const any=watches.some(w=>w.running);
          if(a==='add' && watches.length<5){ const nid=(watches.at(-1)?.id??-1)+1; watches.push({id:nid,name:`時計 ${nid+1}`,running:false,start:0,elapsed:0,lastLap:0,laps:[],target:0,freezeUntil:0,frozenLap:0,pendingLast:null});
