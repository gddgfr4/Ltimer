<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no,viewport-fit=cover" />
<title>多機能トレーニングタイマー Pro — 5台改善</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root{
    --approaching-warn-color:#facc15;--approaching-imminent-color:#fb923c;--exceeded-color:#f87171;--work-color:#4ade80;--rest-color:#60a5fa;
  }
  html,body{height:100dvh;margin:0;padding:0;overflow:hidden}
  body{touch-action:manipulation;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif}
  .timer-font{font-variant-numeric:tabular-nums}
  .content-container{height:100%;overflow:auto;background:#e5e7eb;padding-bottom:env(safe-area-inset-bottom)}

  /* Split */
  .split-grid{display:grid;flex-grow:1;padding:4px;gap:6px}
  .split-card{height:100%;display:grid;grid-template-columns:1fr 1fr;grid-template-rows:auto auto auto 1fr auto;gap:6px;padding:8px;background:#F9FAFB;border-radius:.5rem}
  .split-card-header{grid-column:1 / -1;display:grid;grid-template-columns:1fr minmax(86px,42%);gap:6px;align-items:center}
  .split-name-input{min-width:0;text-align:left}
  .target-lap-input{min-width:0;text-align:center;padding:4px 6px}

  .split-main-time{grid-column:1 / -1;font-size:clamp(20px,6.4vw,32px)}
  .split-lap-live{grid-column:1 / -1;font-weight:800;border-radius:.375rem;padding:4px 6px;font-size:clamp(22px,7.5vw,36px)}
  .split-lap-live.good{color:#065f46;background:#d1fae5}
  .split-lap-live.warn{color:#7c2d12;background:#ffedd5}
  .split-lap-live.bad{color:#991b1b;background:#fee2e2}

  /* 履歴は常にスクロール可能・最低1行は見える */
  .split-lap-history{grid-column:1 / -1;min-height:1.6em;overflow-y:auto;background:rgba(229,231,235,.8);border-radius:.375rem;padding:6px}

  /* 履歴1行の詰めレイアウト（番号と時間の間隔を小さく） */
  .lap-row{display:flex;align-items:baseline;gap:6px;line-height:1.15}
  .lap-row .n{font-weight:700;min-width:1.6em;text-align:right}
  .lap-row .t{font-variant-numeric:tabular-nums}
  .lap-row .c{color:#6b7280;margin-left:4px}

  /* ボタンの高さは固定 */
  .split-actions{grid-column:1 / -1;display:grid;grid-template-columns:1fr 1fr;gap:6px}
  .split-actions button{height:56px}

  /* 画面が狭い時の微調整 */
  @media (max-width:430px){
    .split-card{gap:4px;padding:6px}
    .split-card-header{grid-template-columns:1fr minmax(80px,48%);gap:4px}
    .split-actions button{height:52px}
  }

  /* === 5台モード専用の詰め設定 === */
  .five-cards .split-card{gap:6px}
  .five-cards .split-lap-history{font-size:clamp(12px,3.2vw,14px);line-height:1.15;min-height:1.8em}
  .five-cards .split-main-time{font-size:clamp(18px,5.6vw,28px)}
  .five-cards .split-lap-live{font-size:clamp(20px,6.8vw,32px)}
</style>
</head>
<body>
  <div id="container-split" class="content-container">
    <div class="split-container">
      <div id="split-grid" class="split-grid"></div>
      <div id="split-master-controls" class="bg-gray-800 flex items-center justify-around p-2"></div>
    </div>
  </div>

<script>
(()=>{
  const grid = document.getElementById('split-grid');
  const controls = document.getElementById('split-master-controls');
  let splitWatches = [];

  function formatTime(ms){
    if(isNaN(ms)||ms<0) ms=0;const d=new Date(ms);const m=String(d.getUTCMinutes());const s=String(d.getUTCSeconds()).padStart(2,'0');const h=String(Math.floor(d.getUTCMilliseconds()/10)).padStart(2,'0');return `${m}:${s}.${h}`;
  }

  function setGridStyle(count){
    const cols = (count>3)?2:1; grid.style.gridTemplateColumns = (cols===2)?'1fr 1fr':'1fr';
    // 5個の時はクラス付与で詰めレイアウト
    grid.classList.toggle('five-cards', count>=5);

    const container = document.getElementById('container-split');
    const availableH = container.clientHeight - controls.offsetHeight;
    const style = getComputedStyle(grid); const padV = parseFloat(style.paddingTop)+parseFloat(style.paddingBottom);
    const gap = parseFloat(style.gap)||6; const rows = Math.ceil(count/cols);
    const minRow = (count>=5)? 210 : 180; // 5台時は最小行高を少し上げて履歴の1行を確保
    const rowH = Math.max(minRow, Math.floor((availableH - padV - (rows-1)*gap)/rows));
    grid.style.gridAutoRows = rowH+'px';
  }

  function render(){
    setGridStyle(splitWatches.length);
    grid.innerHTML = splitWatches.map(sw=>{
      let cum=0; const hist = sw.laps.map((lap,i)=>{cum+=lap;return{n:i+1,lap,cum}}).slice().reverse()
        .map(h=>`<div class="lap-row"><span class="n">${h.n}:</span><span class="t">${formatTime(h.lap)}</span><span class="c">(${formatTime(h.cum)})</span></div>`).join('')
        || '<p class="text-xs text-center text-gray-400">ラップ履歴</p>';
      return `
      <div class="split-card" id="watch-${sw.id}">
        <div class="split-card-header">
          <input type="text" value="${sw.name}" data-id="${sw.id}" class="split-name-input font-bold text-lg p-1 bg-gray-100 rounded">
          <input type="number" data-id="${sw.id}" placeholder="目標(sec)" value="${sw.targetLapSeconds>0?sw.targetLapSeconds:''}" class="target-lap-input border-2 rounded-md">
        </div>
        <div class="split-main-time timer-font text-gray-800">${formatTime(sw.elapsed)}</div>
        <div class="split-lap-live timer-font" id="lap-live-${sw.id}">${formatTime(sw.elapsed - sw.lastLapTime)}</div>
        <div class="split-lap-history">${hist}</div>
        <div class="split-actions">
          <button data-id="${sw.id}" data-action="start-stop" class="py-2 text-white font-bold rounded-md text-lg ${sw.running?'bg-red-500':'bg-green-500'}">${sw.running?'STOP':'START'}</button>
          <button data-id="${sw.id}" data-action="lap" class="py-2 text-white font-bold rounded-md text-lg bg-gray-700">LAP (${sw.laps.length+1})</button>
        </div>
      </div>`;
    }).join('');

    // controls（省略: 元のまま）
    const anyRunning = splitWatches.some(sw=>sw.running);
    controls.innerHTML = `
      <button data-action="add" class="px-3 py-2 text-white bg-blue-500 rounded-full w-12 h-12 text-2xl ${splitWatches.length>=5?'opacity-50':''}" ${splitWatches.length>=5?'disabled':''}>+</button>
      <button data-action="remove" class="px-3 py-2 text-white bg-gray-500 rounded-full w-12 h-12 text-2xl ${splitWatches.length<=1?'opacity-50':''}" ${splitWatches.length<=1?'disabled':''}>-</button>
      <button data-action="start-all" class="px-4 py-2 text-white bg-green-500 rounded">START ALL</button>
      <button data-action="stop-all" class="px-4 py-2 text-white bg-red-500 rounded">STOP ALL</button>
      <button data-action="reset-all" class="px-4 py-2 text-white ${anyRunning?'bg-gray-500':'bg-orange-500'} rounded" ${anyRunning?'disabled':''}>RESET ALL</button>`;
  }

  function init(){
    splitWatches=[...Array(5)].map((_,i)=>({id:i,name:`時計 ${i+1}`,running:false,startTime:0,elapsed:0,lastLapTime:0,laps:[],targetLapSeconds:0}));
    render();
  }

  // --- handlers (最小限デモ用) ---
  document.getElementById('container-split').addEventListener('click',e=>{
    const btn=e.target.closest('button'); if(!btn) return; const act=btn.dataset.action; const id=parseInt(btn.dataset.id);
    const sw=splitWatches.find(w=>w.id===id);
    if(act==='start-stop'&&sw){sw.running=!sw.running; if(sw.running) sw.startTime=Date.now()-sw.elapsed;}
    if(act==='lap'&&sw&&sw.running){const now=Date.now(); sw.elapsed=now-sw.startTime; const lap=sw.elapsed-sw.lastLapTime; sw.lastLapTime=sw.elapsed; sw.laps.push(lap);} 
    if(act==='add'&&splitWatches.length<5){const nid=Math.max(...splitWatches.map(s=>s.id))+1; splitWatches.push({id:nid,name:`時計 ${nid+1}`,running:false,startTime:0,elapsed:0,lastLapTime:0,laps:[],targetLapSeconds:0});}
    if(act==='remove'&&splitWatches.length>1){splitWatches.pop();}
    render();
  });

  // tick（最小）
  function tick(){
    const now=Date.now();
    splitWatches.forEach(sw=>{if(!sw.running) return; sw.elapsed=now-sw.startTime; const live=document.getElementById('lap-live-'+sw.id); if(live) live.textContent=formatTime(sw.elapsed-sw.lastLapTime); const card=document.getElementById('watch-'+sw.id); if(card){card.querySelector('.split-main-time').textContent=formatTime(sw.elapsed);}});
    requestAnimationFrame(tick);
  }

  window.addEventListener('resize',()=>setGridStyle(splitWatches.length));
  init(); tick();
})();
</script>
</body>
</html>
